<h2>Установка и настройка подключения Ejabberd 16.01 по VPN к удаленным серверам, с централизованным хранением сообщений и личных карт пользователей в БД MySQL</h2>

Ejabberd работает с портами: 5280, 5269, 5222 (5223).


1) <h3>Установка на ОС Ubuntu 16.04:</h3>

Загружаем пакет с официального сайта - https://github.com/processone/ejabberd/archive/16.01.zip

Официальный GitHub - https://github.com/processone/ejabberd

или:

1) **`sudo apt update`**  - обновляем информацию о репозиториях, 

<i>последняя актуальная вресия для данной OS - Ejabberd 16.01</i>

---
1) **`sudo apt-get install ejabberd`** - устанавливаем с репозитрия Ubuntu - Ejabebrd
2) **`sudo apt-get install erlang-p1-mysql`** - важный пакет erlang для работы с DB Mysql
3) **`sudo service ejabberd stop`** - останавливаем сервис для дальнейшей конфигурации
---

2) <h3>Установка и настройка БД Mysql</h3>

Устанавливаем пакет с репозитория Ubuntu:

---
1) **`sudo apt-get install mysql`**
2) **`sudo service mysql start`**
---

Логинимся в Mysql и создаем новую БД с именем Ejabberd:

---
1) **`mysql -u root -p`**
2) **`CREATE DATABASE ejabberd;`**
---

Создаем нового пользователя с именем ejabberd и закрываем Mysql:

---
1) **`GRANT ALL ON ejabberd.* TO 'ejabberd'@'localhost' IDENTIFIED BY 'пароль пользователя';`**
2) **`quit;`**
---

3) <h3>Конфигурация сервера</h3>
  
Далее с помощью текстового редактора открываем файл ejabberd.yml с правами суперпользователя:

---
1) **`vim /etc/ejabberd/ejabberd.yml`**
---

<i>"Внимание! Обращаем внимание на то, что файл с расширением .yml имеет крайне чувствительный синтаксис YAML, не рекомендуется переносить строки, ставить лишние пробелы в отличии от тех, которые уже существуют в самом файле, и не в коем случае не нажимать на клавишу табуляции" (Tab).</i>

Находим строку с перечислением хостов hosts, меняем значение localhost на имя вашего сервера:

---
1) **`hosts: ["имя сервера(полоностью)"]`**
---

Далее находим закоментированную строку ## MySQL server: и меняем значения на те, которые вы ввели mysql, попутно раскоментирую все строки ниже и ОБЯЗАТЕЛЬНО УБИРАЯ ПРОБЕЛЫ ДО НАЧАЛА ФАЙЛА!:

---
1) **`odbc_type: mysql`**
2) **`odbc_server: "localhost"`**
3) **`odbc_database: "ejabberd"`**
4) **`odbc_username: "ejabberd"`**
5) **`odbc_password: "пароль пользователя"`**
---

Находим последнюю строку admin и меняем хост подключения с localhost на имя сервера:

---
1) **`"admin": "bereg.web.local.net"`**
---

Запускаем сервис ejabberd и делаем рестарт ejabberdctl:

---
1) **`sudo service ejabberd start`**
2) **`ejabberdctl start`**
---

Добавляем нового пользователя admin с помощью утилиты ejabberdctl и делаем перезагрузку:

---
1) **`ejabberdctl register admin имя_сервера(полность) пароль пользователя`**
2) **`sudo service ejabberd restart`**
3) **`ejabberdctl restart`**
---

<i>Внимание! Во время перезагрузки службы ejabberdctl вы можете столкнуться с ошибкой:</i>

 **`/usr/sbin/ejabberdctl: line 428: 4052 Segmentation fault $EXEC_CMD`**

Как её исправить: 
Открываем файл:

---
1) **`/etc/apparmor.d/usr.sbin.ejabberdctl`**
---

Находим строку в файле:

---
1) **`/bin/su                     r,`**
---

И добавляем букву "m" сразу после буквы "r" сохраняем файл и перезагружаем службы apparmor и ejabberdctl:

---
1) **`/bin/su                     rm,`**
2) **`sudo service apparmor restart`**
3) **`ejabberrdctl restart`**
---

Переходим по url-адресу: https://имя_сервера:5280/admin (SSL - обязательно) и вводим JID созданного администратора (admin@имя_сервера) и созданный пароль.

Далее мы попадаем в панель администратора, где нужно завести пользователей и ОБЯЗАТЕЛЬНО поместить их в созданные группы, иначе вы не увидите пользователей в общем ростере. 
Только после этого мы можем загрузить клиентское приложение себе на компьютер и подключиться к своем аккаунту.


3) <h3>Конфигурация сервера c VPN</h3>

Пусть у нас есть настроенный сервер Ejabberd, нам нужно подключиться к такому же удаленному серверу с ip-адресом "192.168.6.23", а так же у нас настроена связь по VPN каналу, ip-адресс удаленного сервера "10.3.0.2"

Узнаем ip-адреса удаленного сервера имеющего подключение по VPN и создаем маршрутизацию:

---
1) **`route add -net 192.168.6.23 netmask 255.255.255.0 gateway 172.16.5.8 (интерфейс подключения) eno3`**
2) **`route add -net 10.3.0.2 netmask 255.255.255.255 gateway 172.16.5.8 (интерфейс подключения) eno3`**
---

Проверяем утилитой netstat маршрутизацию подключений:

---
1) **`netstat -n -r`**
---
Редактируем DNS-сервер по-умолчанию в файле /etc/resolv.conf

---
1) **`vim /etc/resolv.conf`**
2) **`nameserver 172.16.5.88`**
---

Пингуем сервера: 192.168.6.23 и 10.3.0.2

---
1) **`ping 192.168.6.23`**
2) **`ping 10.3.0.2`**
---

Обязательно говорим системному администратора отвечающего за другой сервер DNS, что мы хотим к нему подключиться, так как ему нужно прописать адрес нашего сервера в свой DNS.


Настройка подключения у удаленному серверу по VPN завершена.


3) <h3>Создание централизованного хранения сообщений и карт пользователей в БД MySQL</h3>  

Загружаем файл с запросами Mysql: `https://github.com/processone/ejabberd/archive/16.01.zip` Путь: /sql/mysql.sql
Заходим в БД Mysql из той же папки куда загрузили файл "mysql.sql", переходим к базе ejabberd и загружаем его туда:

---
1) **`mysql -u ejabberd -p`**
2) **`use ejabberd;`**
3) **`source mysql.sql;`**
4) **`show tables;`** - проверяем заполнилась ли таблица
5) **`quit;`**
---

C помощью текстового редактора открываем этот файл с правами суперпользователя и находим строку <i>auth_method</i>:

---
1) **`vim /etc/ejabberd/ejabberd.yml`**
2) **`auth_method: internal`**
Меняем на:
3) **`<b>auth_method: odbc`**
---

Далее редактируем следующие модули:

* <b>mod_last</b>     <i>правим в</i>  <b>mod_last_odbc</b>
* <b>mod_muc</b>      <i>правим в</i>  <b>mod_muc_odbc</b>
* <b>mod_privacy</b>  <i>правим в</i>  <b>mod_privacy_odbc</b>
* <b>mod_private</b>  <i>правим в</i>  <b>mod_private_odbc</b>
* <b>mod_roster</b>   <i>правим в</i>  <b>mod_roster_odbc</b>

3) Добавляем опции к модулю:

* <b>mod_vcard:</b> { } <i>правим в</i> <b>mod_vcard:</b> {
                                            search: true
                          }

* <b>mod_mam:</b> { } <i>правим в</i> <b>mod_mam:</b> {
                                            db_type: odbc
                                            default: roster
                                            request_activates_archiving: true
                                            cache_size: 1000
                                            cache_life_time: 3600
                          }
4) Перезапускаем сервис <i>ejabberd</i>:

* <code><b>sudo service ejabberd restart</b></code>
* <code><b>ejabberdctl restart</b></code>

<i>Внимание! Если пропал доступ к личному кабинету <a>jabber:5280/admin</a>, то зарегистрируйте пользователя admin повторно:</i>

* <code><b>ejabberdctl register admin имя_сервера(полностью) пароль пользователя</b></code>

5) Переходим по url-адресу: https://имя-сервера:5280/admin (SSL - обязательно) и вводим JID созданного администратора (admin@bereg.web.local.net) и созданный пароль.

Настройка сервера завершена.
